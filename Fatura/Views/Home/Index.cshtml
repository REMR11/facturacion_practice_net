@using Fatura.Models.Catalogos
@model IEnumerable<Producto>

@{
    ViewData["Title"] = "Inicio";
}

<!-- ======= CONTENIDO ======= -->

<section class="productos-section">
    <h2 class="text-center fw-bold mb-4 productos-title">ðŸ›’ Productos para Motos</h2>

    <div class="row g-4 productos-grid">
        @if (Model != null && Model.Any())
        {
            @foreach (var producto in Model)
            {
                <div class="col-6 col-sm-6 col-md-4 col-lg-3 col-xl-2">
                    <div class="card h-100 shadow-sm producto-card">
                        @{
                            var imagenUrl = GetProductImage(producto.NombreProducto);
                        }
                        <img src="@imagenUrl" class="card-img-top p-3 producto-image" alt="@producto.NombreProducto">
                        <div class="card-body text-center d-flex flex-column producto-body">
                            <h5 class="card-title producto-name">@producto.NombreProducto</h5>
                            <p class="card-text text-muted flex-grow-1 producto-desc">@(producto.Descripcion ?? "Producto de calidad")</p>
                            <p class="fw-bold text-success fs-5 producto-price">$@(producto.Precio?.ToString("F2") ?? "0.00")</p>
                        </div>
                        <div class="card-footer bg-white text-center producto-footer">
                            <button class="btn btn-success btn-sm w-100 btn-add-cart" 
                                    data-producto-id="@producto.IdProducto"
                                    data-producto-nombre="@producto.NombreProducto"
                                    data-producto-precio="@(producto.Precio ?? 0)">
                                <i class="fas fa-cart-plus"></i> <span class="d-none d-sm-inline">Agregar</span>
                            </button>
                        </div>
                    </div>
                </div>
            }
        }
        else
        {
            <div class="col-12 text-center">
                <p class="text-muted">No hay productos disponibles en este momento.</p>
            </div>
        }
    </div>
</section>

@functions {
    private string GetProductImage(string nombreProducto)
    {
        var nombreLower = nombreProducto.ToLower();
        if (nombreLower.Contains("casco"))
            return "~/css/Image/Casco.png";
        if (nombreLower.Contains("aceite"))
            return "~/css/Image/Aceite.png";
        if (nombreLower.Contains("guante"))
            return "~/css/Image/Guantes.png";
        if (nombreLower.Contains("bujÃ­a") || nombreLower.Contains("bujia"))
            return "~/css/Image/Bujia.png";
        if (nombreLower.Contains("bobina"))
            return "~/css/Image/Casco.png"; // Imagen por defecto para bobinas
        if (nombreLower.Contains("interruptor"))
            return "~/css/Image/Casco.png";
        if (nombreLower.Contains("cable"))
            return "~/css/Image/Casco.png";
        if (nombreLower.Contains("regulador"))
            return "~/css/Image/Casco.png";
        if (nombreLower.Contains("filtro"))
            return "~/css/Image/Aceite.png";
        if (nombreLower.Contains("embolo") || nombreLower.Contains("Ã©mbolo"))
            return "~/css/Image/Casco.png";
        if (nombreLower.Contains("bateria") || nombreLower.Contains("baterÃ­a"))
            return "~/css/Image/Casco.png";
        if (nombreLower.Contains("pastilla") || nombreLower.Contains("freno"))
            return "~/css/Image/Guantes.png";
        return "~/css/Image/Casco.png"; // Imagen por defecto
    }
}

@section Scripts {
    @Html.AntiForgeryToken()
    <script>
        function getToken() {
            const token = document.querySelector('input[name="__RequestVerificationToken"]');
            return token ? token.value : '';
        }

        document.addEventListener('DOMContentLoaded', function() {
            document.querySelectorAll('.btn-add-cart').forEach(button => {
                button.addEventListener('click', function() {
                    const productoId = this.getAttribute('data-producto-id');
                    const productoNombre = this.getAttribute('data-producto-nombre');
                    
                    // Mostrar feedback visual
                    const originalText = this.innerHTML;
                    this.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Agregando...';
                    this.disabled = true;
                    
                    fetch('@Url.Action("AddToCart", "Cart")', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'RequestVerificationToken': getToken()
                        },
                        body: JSON.stringify({
                            productoId: parseInt(productoId),
                            cantidad: 1
                        })
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            // Mostrar notificaciÃ³n
                            showNotification('Producto agregado al carrito', 'success');
                            // Actualizar contador del carrito si existe
                            updateCartCount(data.cartCount);
                        } else {
                            showNotification(data.message || 'Error al agregar producto', 'error');
                        }
                    })
                    .catch(error => {
                        console.error('Error:', error);
                        showNotification('Error al agregar producto', 'error');
                    })
                    .finally(() => {
                        this.innerHTML = originalText;
                        this.disabled = false;
                    });
                });
            });
        });

        function showNotification(message, type) {
            // Crear notificaciÃ³n
            const notification = document.createElement('div');
            notification.className = `alert alert-${type === 'success' ? 'success' : 'danger'} position-fixed`;
            const isMobile = window.innerWidth <= 480;
            notification.style.cssText = isMobile 
                ? 'top: 10px; right: 10px; left: 10px; z-index: 9999; max-width: calc(100% - 20px);'
                : 'top: 20px; right: 20px; z-index: 9999; min-width: 300px; max-width: 400px;';
            notification.innerHTML = `
                <div class="d-flex align-items-center">
                    <i class="fas fa-${type === 'success' ? 'check-circle' : 'exclamation-circle'} me-2"></i>
                    <span class="flex-grow-1">${message}</span>
                    <button type="button" class="btn-close ms-2" onclick="this.closest('.alert').remove()"></button>
                </div>
            `;
            document.body.appendChild(notification);
            
            // Auto-remover despuÃ©s de 3 segundos
            setTimeout(() => {
                if (notification.parentElement) {
                    notification.remove();
                }
            }, 3000);
        }

        function updateCartCount(count) {
            // Usar la funciÃ³n global si existe
            if (typeof window.updateCartCount === 'function') {
                window.updateCartCount(count);
            } else {
                // Fallback: buscar y actualizar contador del carrito en el navbar
                const cartIcon = document.querySelector('.fa-shopping-cart');
                if (cartIcon && count > 0) {
                    let badge = cartIcon.parentElement.querySelector('#cartBadge');
                    if (!badge) {
                        badge = document.createElement('span');
                        badge.id = 'cartBadge';
                        badge.className = 'badge bg-danger position-absolute top-0 start-100 translate-middle';
                        badge.style.cssText = 'font-size: 0.7rem; padding: 0.25em 0.5em;';
                        cartIcon.parentElement.style.position = 'relative';
                        cartIcon.parentElement.appendChild(badge);
                    }
                    badge.textContent = count;
                    badge.style.display = 'inline-block';
                }
            }
        }
    </script>
}
