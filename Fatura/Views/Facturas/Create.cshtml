@using Fatura.Models.Facturacion

@{
    ViewData["Title"] = "Nueva Factura";
    Layout = "~/Views/Shared/_DashboardLayout.cshtml";
    var factura = Model as Factura;
}

<div class="factura-container">
    <div class="factura-header">
        <a href="@Url.Action("Index", "Facturas")" class="btn-back">
            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" />
            </svg>
        </a>
        <div>
            <h1 class="factura-title">Nueva Factura</h1>
            <p class="factura-subtitle">Completa los datos para crear una factura electrónica</p>
        </div>
    </div>

    <form method="post" asp-action="Create" id="facturaForm" class="factura-form">
        <div class="factura-content">
            <!-- Left Column -->
            <div class="factura-left">
                <!-- Datos del Cliente -->
                <div class="form-section">
                    <h3 class="section-title">Datos del Cliente</h3>
                    
                    <div class="form-group">
                        <label for="clienteSearch" class="form-label">Cliente</label>
                        <div class="search-container">
                            <input type="text" id="clienteSearch" class="form-control" placeholder="Buscar cliente por nombre o RUC..." autocomplete="off">
                            <div id="clienteList" class="autocomplete-list"></div>
                        </div>
                        <input type="hidden" id="clienteId" name="ClienteId" />
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label for="nit" class="form-label">RUC / DNI</label>
                            <input type="text" id="nit" class="form-control" readonly placeholder="2012345789">
                        </div>
                        <div class="form-group">
                            <label for="email" class="form-label">Email</label>
                            <input type="email" id="email" class="form-control" readonly placeholder="cliente@empresa.com">
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="direccion" class="form-label">Dirección fiscal</label>
                        <input type="text" id="direccion" class="form-control" readonly placeholder="Av. Principal 123, Lima">
                    </div>
                </div>

                <!-- Productos / Servicios -->
                <div class="form-section">
                    <div class="section-header">
                        <h3 class="section-title">Productos / Servicios</h3>
                        <button type="button" class="btn-add-item" id="btnAgregarProducto">
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" />
                            </svg>
                            Agregar Ítem
                        </button>
                    </div>

                    <div class="products-table">
                        <table>
                            <thead>
                                <tr>
                                    <th>Producto/Servicio</th>
                                    <th>Cantidad</th>
                                    <th>Precio Unit.</th>
                                    <th>Desc. %</th>
                                    <th>Subtotal</th>
                                    <th></th>
                                </tr>
                            </thead>
                            <tbody id="productosBody">
                                <tr id="item-1" class="product-item">
                                    <td>
                                        <select class="form-control producto-select" name="DetalleFactura[0].ProductoId">
                                            <option value="">Seleccionar...</option>
                                        </select>
                                    </td>
                                    <td>
                                        <input type="number" class="form-control cantidad" name="DetalleFactura[0].Cantidad" value="1" min="1">
                                    </td>
                                    <td>
                                        <input type="number" class="form-control precio-unit" name="DetalleFactura[0].PrecioUnitario" step="0.01" value="0.00" readonly>
                                    </td>
                                    <td>
                                        <input type="number" class="form-control descuento" name="DetalleFactura[0].Descuento" step="0.01" value="0">
                                    </td>
                                    <td>
                                        <input type="number" class="form-control subtotal" value="0.00" readonly>
                                    </td>
                                    <td>
                                        <button type="button" class="btn-delete" onclick="eliminarProducto(1)">
                                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3H4v2h16V7h-3z" />
                            </svg>
                                        </button>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>

                    <div class="form-group">
                        <label for="descripcion" class="form-label">Descripción adicional</label>
                        <textarea id="descripcion" class="form-control" rows="3" placeholder="Detalles adicionales del producto o servicio..."></textarea>
                    </div>
                </div>

                <!-- Notas y Observaciones -->
                <div class="form-section">
                    <h3 class="section-title">Notas y Observaciones</h3>
                    <div class="form-group">
                        <textarea id="observaciones" name="Observaciones" class="form-control" rows="4" placeholder="Notas adicionales que aparecerán en la factura..."></textarea>
                    </div>
                </div>
            </div>

            <!-- Right Column -->
            <div class="factura-right">
                <!-- Detalles de Factura -->
                <div class="form-section">
                    <h3 class="section-title">Detalles de Factura</h3>

                    <div class="form-group">
                        <label for="tipoDocumento" class="form-label">Tipo de documento</label>
                        <select id="tipoDocumento" name="TipoDocumento" class="form-control">
                            <option value="01">Factura Electrónica</option>
                            <option value="03">Comprobante de Crédito Fiscal</option>
                            <option value="04">Nota de Remisión</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label for="serie" class="form-label">Serie</label>
                        <select id="serie" name="SerieFactura" class="form-control">
                            <option value="F001">F001</option>
                            <option value="F002">F002</option>
                            <option value="F003">F003</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label for="fechaEmision" class="form-label">Fecha de emisión</label>
                        <input type="date" id="fechaEmision" name="FechaEmision" class="form-control" value="@DateTime.Today.ToString("yyyy-MM-dd")">
                    </div>

                    <div class="form-group">
                        <label for="fechaVencimiento" class="form-label">Fecha de vencimiento</label>
                        <input type="date" id="fechaVencimiento" name="FechaVencimiento" class="form-control" value="@DateTime.Today.AddDays(30).ToString("yyyy-MM-dd")">
                    </div>

                    <div class="form-group">
                        <label for="moneda" class="form-label">Moneda</label>
                        <select id="moneda" name="MonedaSimbolo" class="form-control">
                            <option value="USD">Dólares (USD)</option>
                            <option value="SVC">Colones (SVC)</option>
                            <option value="MXN">Pesos (MXN)</option>
                        </select>
                    </div>

                    <!-- Resumen -->
                    <div class="resumen-section">
                        <h4 class="resumen-title">
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 24 24">
                                <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z"/>
                            </svg>
                            Resumen
                        </h4>
                        
                        <div class="resumen-item">
                            <span>Subtotal:</span>
                            <span id="subtotalValue">$0.00</span>
                        </div>

                        <div class="resumen-item">
                            <span>IGV (18%):</span>
                            <span id="ivaValue">$0.00</span>
                        </div>

                        <div class="resumen-item">
                            <span>ISR:</span>
                            <span id="isrValue">$0.00</span>
                        </div>

                        <div class="resumen-total">
                            <span>Total</span>
                            <span id="totalValue">$0.00</span>
                        </div>
                    </div>

                    <!-- Action Buttons -->
                    <div class="action-buttons">
                        <button type="button" class="btn btn-secondary" id="btnGuardar">
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7H5a2 2 0 00-2 2v9a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-3m-1 4m-1 0V7a2 2 0 012-2h2a2 2 0 012 2v2m0 0V7a2 2 0 00-2-2h-2a2 2 0 00-2 2v2m0 0s0 0 0 0m0 4h6m-6 4h6" />
                            </svg>
                            Guardar borrador
                        </button>
                        <button type="button" class="btn btn-primary" id="btnPreview">
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z" />
                            </svg>
                            Previsualizar
                        </button>
                        <button type="submit" class="btn btn-success" id="btnEmitir">
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
                            </svg>
                            Emitir Factura
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </form>
</div>

<style>
    .factura-container {
        max-width: 1400px;
        margin: 0 auto;
    }

    .factura-header {
        display: flex;
        align-items: flex-start;
        gap: 1rem;
        margin-bottom: 2rem;
    }

    .btn-back {
        display: flex;
        align-items: center;
        justify-content: center;
        width: 40px;
        height: 40px;
        border-radius: 8px;
        background-color: #f3f4f6;
        color: #1f2937;
        text-decoration: none;
        transition: all 0.2s;
    }

    .btn-back:hover {
        background-color: #e5e7eb;
    }

    .factura-title {
        font-size: 1.875rem;
        font-weight: 600;
        color: #1f2937;
        margin: 0 0 0.5rem 0;
    }

    .factura-subtitle {
        font-size: 0.9375rem;
        color: #6b7280;
        margin: 0;
    }

    .factura-form {
        background: white;
        border-radius: 12px;
        box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1);
        overflow: hidden;
    }

    .factura-content {
        display: grid;
        grid-template-columns: 2fr 1fr;
        gap: 2rem;
        padding: 2rem;
    }

    .form-section {
        margin-bottom: 2rem;
    }

    .form-section:last-child {
        margin-bottom: 0;
    }

    .section-title {
        font-size: 1rem;
        font-weight: 600;
        color: #1f2937;
        margin: 0 0 1.5rem 0;
        border-bottom: 2px solid #10b981;
        padding-bottom: 0.75rem;
    }

    .section-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 1.5rem;
    }

    .section-header .section-title {
        border: none;
        padding: 0;
        margin: 0;
    }

    .btn-add-item {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        padding: 0.5rem 1rem;
        background-color: #10b981;
        color: white;
        border: none;
        border-radius: 6px;
        font-size: 0.875rem;
        font-weight: 500;
        cursor: pointer;
        transition: background-color 0.2s;
    }

    .btn-add-item:hover {
        background-color: #059669;
    }

    .form-label {
        display: block;
        font-size: 0.875rem;
        font-weight: 500;
        color: #1f2937;
        margin-bottom: 0.5rem;
    }

    .form-control {
        width: 100%;
        padding: 0.625rem 0.75rem;
        border: 1px solid #e5e7eb;
        border-radius: 6px;
        font-size: 0.875rem;
        transition: border-color 0.2s;
    }

    .form-control:focus {
        outline: none;
        border-color: #10b981;
        box-shadow: 0 0 0 3px rgba(16, 185, 129, 0.1);
    }

    .form-group {
        margin-bottom: 1rem;
    }

    .form-row {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 1rem;
    }

    .search-container {
        position: relative;
    }

    .autocomplete-list {
        position: absolute;
        top: 100%;
        left: 0;
        right: 0;
        background: white;
        border: 1px solid #e5e7eb;
        border-top: none;
        border-radius: 0 0 6px 6px;
        max-height: 300px;
        overflow-y: auto;
        z-index: 10;
        display: none;
    }

    .autocomplete-list.show {
        display: block;
    }

    .autocomplete-item {
        padding: 0.75rem;
        border-bottom: 1px solid #f3f4f6;
        cursor: pointer;
        transition: background-color 0.2s;
    }

    .autocomplete-item:hover {
        background-color: #f9fafb;
    }

    .products-table {
        overflow-x: auto;
        margin-bottom: 1rem;
    }

    .products-table table {
        width: 100%;
        border-collapse: collapse;
        border: 1px solid #e5e7eb;
    }

    .products-table thead {
        background-color: #f9fafb;
    }

    .products-table th {
        padding: 0.75rem;
        text-align: left;
        font-size: 0.75rem;
        font-weight: 600;
        text-transform: uppercase;
        color: #6b7280;
        border-bottom: 1px solid #e5e7eb;
    }

    .products-table td {
        padding: 0.75rem;
        border-bottom: 1px solid #e5e7eb;
    }

    .products-table input,
    .products-table select {
        width: 100%;
        padding: 0.5rem;
        border: 1px solid #e5e7eb;
        border-radius: 4px;
        font-size: 0.875rem;
    }

    .btn-delete {
        background: none;
        border: none;
        color: #ef4444;
        cursor: pointer;
        padding: 0.5rem;
        transition: color 0.2s;
    }

    .btn-delete:hover {
        color: #dc2626;
    }

    .resumen-section {
        background-color: #f9fafb;
        border-radius: 8px;
        padding: 1.5rem;
        margin-top: 1.5rem;
    }

    .resumen-title {
        font-size: 0.875rem;
        font-weight: 600;
        color: #1f2937;
        margin: 0 0 1rem 0;
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }

    .resumen-title svg {
        color: #10b981;
    }

    .resumen-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        font-size: 0.875rem;
        color: #6b7280;
        padding: 0.5rem 0;
    }

    .resumen-item span:last-child {
        font-weight: 500;
        color: #1f2937;
    }

    .resumen-total {
        display: flex;
        justify-content: space-between;
        align-items: center;
        font-size: 1.25rem;
        font-weight: 700;
        color: #10b981;
        padding: 1rem 0;
        border-top: 2px solid #e5e7eb;
        margin-top: 1rem;
    }

    .action-buttons {
        display: flex;
        flex-direction: column;
        gap: 0.75rem;
        margin-top: 1.5rem;
    }

    .btn {
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 0.5rem;
        padding: 0.75rem 1rem;
        border: none;
        border-radius: 6px;
        font-size: 0.875rem;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.2s;
        width: 100%;
    }

    .btn-primary {
        background-color: #3b82f6;
        color: white;
    }

    .btn-primary:hover {
        background-color: #2563eb;
    }

    .btn-secondary {
        background-color: #6b7280;
        color: white;
    }

    .btn-secondary:hover {
        background-color: #4b5563;
    }

    .btn-success {
        background-color: #10b981;
        color: white;
    }

    .btn-success:hover {
        background-color: #059669;
    }

    /* Responsive */
    @@media (max-width: 1024px) {
        .factura-content {
            grid-template-columns: 1fr;
        }
    }

    @@media (max-width: 768px) {
        .factura-header {
            flex-direction: column;
        }

        .factura-title {
            font-size: 1.5rem;
        }

        .form-row {
            grid-template-columns: 1fr;
        }

        .products-table {
            font-size: 0.8rem;
        }

        .products-table th,
        .products-table td {
            padding: 0.5rem;
        }

        .products-table input,
        .products-table select {
            padding: 0.4rem;
        }
    }
</style>

<script>
    // Cargar clientes al abrir la página
    let clientes = [];
    let productos = [];
    let contador = 1;

    document.addEventListener('DOMContentLoaded', function () {
        cargarClientes();
        cargarProductos();
        inicializarEventos();
    });

    async function cargarClientes() {
        try {
            const response = await fetch('/api/clientes');
            clientes = await response.json();
        } catch (error) {
            console.error('Error cargando clientes:', error);
        }
    }

    async function cargarProductos() {
        try {
            const response = await fetch('/api/productos');
            productos = await response.json();
            actualizarSelectsProductos();
        } catch (error) {
            console.error('Error cargando productos:', error);
        }
    }

    function actualizarSelectsProductos() {
        document.querySelectorAll('.producto-select').forEach(select => {
            const html = productos.map(p => 
                `<option value="${p.id_producto}">${p.nombre_producto} - $${parseFloat(p.precio).toFixed(2)}</option>`
            ).join('');
            select.innerHTML = '<option value="">Seleccionar...</option>' + html;
        });
    }

    function inicializarEventos() {
        // Búsqueda de clientes
        document.getElementById('clienteSearch').addEventListener('input', function (e) {
            const value = e.target.value.toLowerCase();
            const lista = document.getElementById('clienteList');

            if (!value) {
                lista.classList.remove('show');
                return;
            }

            const filtered = clientes.filter(c =>
                c.nombre.toLowerCase().includes(value) ||
                c.nit_dui.includes(value)
            );

            if (filtered.length > 0) {
                lista.innerHTML = filtered.map(c =>
                    `<div class="autocomplete-item" onclick="seleccionarCliente('${c.id}', '${c.nombre}', '${c.nit_dui}', '${c.email}', '${c.direccion}')">${c.nombre} (${c.nit_dui})</div>`
                ).join('');
                lista.classList.add('show');
            } else {
                lista.classList.remove('show');
            }
        });

        // Agregar producto
        document.getElementById('btnAgregarProducto').addEventListener('click', agregarProducto);

        // Calcular totales
        document.addEventListener('change', function (e) {
            if (e.target.classList.contains('cantidad') || 
                e.target.classList.contains('descuento') ||
                e.target.classList.contains('producto-select')) {
                calcularTotales();
            }
        });

        // Botones de acción
        document.getElementById('btnGuardar').addEventListener('click', guardarBorrador);
        document.getElementById('btnPreview').addEventListener('click', previsualizar);
        document.getElementById('facturaForm').addEventListener('submit', emitirFactura);
    }

    function seleccionarCliente(id, nombre, nit, email, direccion) {
        document.getElementById('clienteId').value = id;
        document.getElementById('clienteSearch').value = nombre;
        document.getElementById('nit').value = nit;
        document.getElementById('email').value = email;
        document.getElementById('direccion').value = direccion;
        document.getElementById('clienteList').classList.remove('show');
    }

    function agregarProducto() {
        contador++;
        const tbody = document.getElementById('productosBody');
        const fila = document.createElement('tr');
        fila.id = `item-${contador}`;
        fila.className = 'product-item';
        fila.innerHTML = `
            <td>
                <select class="form-control producto-select" name="DetalleFactura[${contador - 1}].ProductoId">
                    <option value="">Seleccionar...</option>
                    ${productos.map(p => `<option value="${p.id_producto}">${p.nombre_producto} - $${parseFloat(p.precio).toFixed(2)}</option>`).join('')}
                </select>
            </td>
            <td>
                <input type="number" class="form-control cantidad" name="DetalleFactura[${contador - 1}].Cantidad" value="1" min="1">
            </td>
            <td>
                <input type="number" class="form-control precio-unit" name="DetalleFactura[${contador - 1}].PrecioUnitario" step="0.01" value="0.00" readonly>
            </td>
            <td>
                <input type="number" class="form-control descuento" name="DetalleFactura[${contador - 1}].Descuento" step="0.01" value="0">
            </td>
            <td>
                <input type="number" class="form-control subtotal" value="0.00" readonly>
            </td>
            <td>
                <button type="button" class="btn-delete" onclick="eliminarProducto(${contador})">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3H4v2h16V7h-3z" />
                    </svg>
                </button>
            </td>
        `;
        tbody.appendChild(fila);
        calcularTotales();
    }

    function eliminarProducto(id) {
        const item = document.getElementById(`item-${id}`);
        if (item) {
            item.remove();
            calcularTotales();
        }
    }

    function calcularTotales() {
        let subtotal = 0;

        document.querySelectorAll('.product-item').forEach((row, index) => {
            const selectProducto = row.querySelector('.producto-select');
            const cantidad = parseFloat(row.querySelector('.cantidad').value) || 0;
            const descuento = parseFloat(row.querySelector('.descuento').value) || 0;
            const precioUnitInput = row.querySelector('.precio-unit');
            const subtotalInput = row.querySelector('.subtotal');

            if (selectProducto.value) {
                const producto = productos.find(p => p.id_producto == selectProducto.value);
                if (producto) {
                    const precio = parseFloat(producto.precio) || 0;
                    precioUnitInput.value = precio.toFixed(2);

                    const lineaSubtotal = (precio * cantidad) - descuento;
                    subtotalInput.value = lineaSubtotal.toFixed(2);
                    subtotal += lineaSubtotal;
                }
            }
        });

        const iva = subtotal * 0.18;
        const total = subtotal + iva;

        document.getElementById('subtotalValue').textContent = `$${subtotal.toFixed(2)}`;
        document.getElementById('ivaValue').textContent = `$${iva.toFixed(2)}`;
        document.getElementById('totalValue').textContent = `$${total.toFixed(2)}`;
    }

    function guardarBorrador() {
        alert('Factura guardada como borrador');
    }

    function previsualizar() {
        alert('Previsualizando factura...');
    }

    function emitirFactura(e) {
        e.preventDefault();
        
        const clienteId = document.getElementById('clienteId').value;
        if (!clienteId) {
            alert('Selecciona un cliente');
            return;
        }

        const items = document.querySelectorAll('.product-item');
        if (items.length === 0 || !items[0].querySelector('.producto-select').value) {
            alert('Agrega al menos un producto');
            return;
        }

        // Aquí enviar el formulario al servidor
        document.getElementById('facturaForm').submit();
    }
</script>
