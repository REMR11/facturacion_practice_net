@using Fatura.Models.ViewModels
@model FacturaCreateViewModel

@{
    ViewData["Title"] = "Nueva Factura";
    Layout = "~/Views/Shared/_DashboardLayout.cshtml";
}

<div class="factura-page">
    <!-- Header Area -->
    <div class="factura-header-area">
        <div class="header-left">
            <a href="@Url.Action("Index", "Facturas")" class="btn-back">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18" />
                </svg>
            </a>
            <div>
                <h1 class="page-title">Nueva Factura</h1>
                <p class="page-subtitle">Completa los datos para crear una factura electrónica</p>
            </div>
        </div>
        <div class="header-actions">
            <button type="button" class="btn btn-white" id="btnGuardar">
                <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"></path><polyline points="17 21 17 13 7 13 7 21"></polyline><polyline points="7 3 7 8 15 8"></polyline></svg>
                Guardar borrador
            </button>
            <button type="button" class="btn btn-white" id="btnPreview">
                <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path><circle cx="12" cy="12" r="3"></circle></svg>
                Previsualizar
            </button>
            <button type="button" class="btn btn-primary" id="btnEmitirFactura">
                <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="22" y1="2" x2="11" y2="13"></line><polygon points="22 2 15 22 11 13 2 9 22 2"></polygon></svg>
                Emitir Factura
            </button>
        </div>
    </div>

    <form method="post" asp-action="Create" id="facturaForm">
        @Html.AntiForgeryToken()
        <div asp-validation-summary="All" class="text-danger mb-3"></div>
        <div class="factura-grid">
            <!-- Left Main Column -->
            <div class="factura-main">
                <!-- Cliente Card -->
                <div class="card p-4 mb-4">
                    <h3 class="card-title mb-4">Datos del Cliente</h3>
                    
                    <div class="mb-4">
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <label class="form-label mb-0">Cliente</label>
                            <a href="@Url.Action("Create", "Cliente")" target="_blank" class="btn btn-sm btn-outline-success">
                                <i class="fas fa-user-plus"></i> Nuevo Cliente
                            </a>
                        </div>
                        <div class="search-wrapper">
                            <svg class="search-icon" xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line></svg>
                            <input type="text" id="clienteSearch" class="form-control search-input" placeholder="Buscar cliente por nombre o RUC..." autocomplete="off">
                            <div id="clienteList" class="autocomplete-list"></div>
                        </div>
                        <input type="hidden" id="clienteId" name="ClienteId" />
                        <small class="text-muted">Escribe para buscar o completa los datos manualmente</small>
                    </div>

                    <div class="row g-4 mb-4">
                        <div class="col-md-6">
                            <label class="form-label">RUC / DNI</label>
                            <input type="text" id="nit" name="ClienteNitDui" class="form-control" placeholder="20123456789">
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Email</label>
                            <input type="email" id="email" name="ClienteEmail" class="form-control" placeholder="cliente@empresa.com">
                        </div>
                    </div>

                    <div>
                        <label class="form-label">Dirección fiscal</label>
                        <input type="text" id="direccion" name="ClienteDireccion" class="form-control" placeholder="Av. Principal 123, Lima">
                    </div>
                </div>

                <!-- Productos Card -->
                <div class="card p-4">
                    <div class="d-flex justify-content-between align-items-center mb-4">
                        <h3 class="card-title m-0">Productos / Servicios</h3>
                        <button type="button" class="btn btn-outline-sm" id="btnAgregarProducto">
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>
                            Agregar Ítem
                        </button>
                    </div>

                    <div class="products-container">
                        <div class="products-header">
                            <div class="col-producto">Producto/Servicio</div>
                            <div class="col-cantidad">Cantidad</div>
                            <div class="col-precio">Precio Unit.</div>
                            <div class="col-desc">Desc. %</div>
                            <div class="col-subtotal">Subtotal</div>
                            <div class="col-action"></div>
                        </div>
                        <div id="productosBody">
                            <div id="item-1" class="product-row">
                                <div class="col-producto">
                                    <select class="form-control producto-select" name="Items[0].IdProducto" required>
                                        <option value="">Seleccionar...</option>
                                    </select>
                                </div>
                                <div class="col-cantidad">
                                    <input type="number" class="form-control text-center cantidad" name="Items[0].Cantidad" value="1" min="1" step="1" required>
                                </div>
                                <div class="col-precio">
                                    <input type="number" class="form-control text-end precio-unit" name="Items[0].PrecioUnitario" step="0.01" value="0" readonly>
                                </div>
                                <div class="col-desc">
                                    <input type="number" class="form-control text-center descuento" name="Items[0].Descuento" step="0.01" value="0" min="0">
                                </div>
                                <div class="col-subtotal">
                                    <input type="text" class="form-control text-end subtotal bg-light" value="$0.00" readonly>
                                </div>
                                <div class="col-action">
                                    <button type="button" class="btn-icon-danger" onclick="eliminarProducto(1)">
                                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path></svg>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="mt-4">
                        <label class="form-label">Descripción adicional</label>
                        <textarea id="descripcion" class="form-control" rows="3" placeholder="Detalles adicionales del producto o servicio..."></textarea>
                    </div>
                </div>
            </div>

            <!-- Sidebar Column -->
            <div class="factura-sidebar">
                <div class="card p-4 sticky-sidebar">
                    <h3 class="card-title mb-4">Detalles de Factura</h3>

                    <div class="mb-3">
                        <label class="form-label">Tipo de documento</label>
                <select id="tipoDocumento" name="TipoDocumento" class="form-select custom-select" required>
                            <option value="01">Factura Electrónica</option>
                            <option value="03">Comprobante de Crédito Fiscal</option>
                            <option value="04">Nota de Remisión</option>
                        </select>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Serie</label>
                        <select id="serie" name="SerieFactura" class="form-select custom-select" required>
                            <option value="F001">F001</option>
                            <option value="F002">F002</option>
                            <option value="F003">F003</option>
                        </select>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Fecha de emisión</label>
                        <div class="input-icon-wrapper">
                            <input type="date" id="fechaEmision" name="FechaEmision" class="form-control" value="@(Model?.FechaEmision?.ToString("yyyy-MM-dd") ?? DateTime.Today.ToString("yyyy-MM-dd"))" required>
                        </div>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Fecha de vencimiento</label>
                        <div class="input-icon-wrapper">
                            <input type="date" id="fechaVencimiento" name="FechaVencimiento" class="form-control" value="@(Model?.FechaVencimiento?.ToString("yyyy-MM-dd") ?? DateTime.Today.AddDays(30).ToString("yyyy-MM-dd"))" required>
                        </div>
                    </div>

                    <div class="mb-4">
                        <label class="form-label">Moneda</label>
                        <select id="moneda" name="MonedaSimbolo" class="form-select custom-select" required>
                            <option value="S/">Soles (PEN)</option>
                            <option value="USD" selected>Dólares (USD)</option>
                        </select>
                    </div>

                    <div class="resumen-section pt-4 border-top">
                        <h4 class="resumen-title mb-3">
                            <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-primary me-2"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline><line x1="16" y1="13" x2="8" y2="13"></line><line x1="16" y1="17" x2="8" y2="17"></line><polyline points="10 9 9 9 8 9"></polyline></svg>
                            Resumen
                        </h4>
                        
                        <div class="d-flex justify-content-between mb-2 text-muted">
                            <span>Subtotal</span>
                            <span id="subtotalValue">$0.00</span>
                        </div>
                        <div class="d-flex justify-content-between mb-2 text-muted">
                            <span>IGV (13%)</span>
                            <span id="ivaValue">$0.00</span>
                        </div>
                        <div class="d-flex justify-content-between mb-3 text-muted">
                            <span>Total</span>
                            <span class="fw-bold text-dark" id="totalValue">$0.00</span>
                        </div>
                        
                        <div class="total-display d-flex justify-content-between align-items-center">
                            <span class="total-label">Total a pagar</span>
                            <span class="total-amount" id="finalTotal">$0.00</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </form>

    <!-- Modal de previsualización -->
    <div class="modal fade" id="facturaPreviewModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered modal-xl">
            <div class="modal-content">
                <div class="modal-header">
                    <div>
                        <h5 class="modal-title">Previsualización de Factura</h5>
                        <p class="text-muted mb-0">Revisa la información antes de emitir.</p>
                    </div>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
                </div>
                <div class="modal-body">
                    <div class="row g-4">
                        <div class="col-md-6">
                            <h6 class="mb-2">Cliente</h6>
                            <div class="text-muted small" id="previewClienteNombre">—</div>
                            <div class="text-muted small" id="previewClienteDocumento">—</div>
                            <div class="text-muted small" id="previewClienteEmail">—</div>
                            <div class="text-muted small" id="previewClienteDireccion">—</div>
                        </div>
                        <div class="col-md-6">
                            <h6 class="mb-2">Documento</h6>
                            <div class="text-muted small" id="previewTipoDocumento">—</div>
                            <div class="text-muted small" id="previewSerie">—</div>
                            <div class="text-muted small" id="previewFechaEmision">—</div>
                            <div class="text-muted small" id="previewFechaVencimiento">—</div>
                            <div class="text-muted small" id="previewMoneda">—</div>
                        </div>
                    </div>

                    <div class="mt-4">
                        <h6 class="mb-2">Detalle</h6>
                        <div class="table-responsive">
                            <table class="table table-sm align-middle preview-table">
                                <thead>
                                    <tr>
                                        <th>Producto/Servicio</th>
                                        <th class="text-center">Cant.</th>
                                        <th class="text-end">Precio Unit.</th>
                                        <th class="text-end">Desc.</th>
                                        <th class="text-end">Subtotal</th>
                                    </tr>
                                </thead>
                                <tbody id="previewItems">
                                    <tr>
                                        <td colspan="5" class="text-center text-muted">Sin ítems</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <div class="mt-3">
                        <h6 class="mb-2">Descripción adicional</h6>
                        <div class="text-muted small" id="previewDescripcion">—</div>
                    </div>

                    <div class="d-flex justify-content-end mt-4">
                        <div class="text-end">
                            <div class="text-muted">Subtotal: <span id="previewSubtotal">—</span></div>
                            <div class="text-muted">IGV (13%): <span id="previewIgv">—</span></div>
                            <div class="fw-bold">Total: <span id="previewTotal">—</span></div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-light" data-bs-dismiss="modal">Cerrar</button>
                    <button type="button" class="btn btn-primary" onclick="document.getElementById('facturaForm').requestSubmit()">Emitir Factura</button>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
    /* Custom Variables */
    :root {
        --primary-green: #10b981;
        --primary-green-hover: #059669;
        --bg-gray: #f3f4f6;
        --border-color: #e5e7eb;
        --text-dark: #1f2937;
        --text-light: #6b7280;
    }

    .factura-page {
        max-width: 1600px;
        margin: 0 auto;
    }

    /* Header Styling */
    .factura-header-area {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 2rem;
    }

    .header-left {
        display: flex;
        align-items: center;
        gap: 1rem;
    }

    .btn-back {
        width: 36px;
        height: 36px;
        display: flex;
        align-items: center;
        justify-content: center;
        color: var(--text-dark);
        transition: color 0.2s;
    }
    
    .btn-back:hover {
        color: var(--primary-green);
    }

    .page-title {
        font-size: 1.5rem;
        font-weight: 700;
        color: var(--text-dark);
        margin: 0;
        line-height: 1.2;
    }

    .page-subtitle {
        font-size: 0.875rem;
        color: var(--text-light);
        margin: 0;
    }

    .header-actions {
        display: flex;
        gap: 0.75rem;
    }

    /* Button Styling */
    .btn {
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
        padding: 0.625rem 1rem;
        border-radius: 8px;
        font-weight: 500;
        font-size: 0.875rem;
        transition: all 0.2s;
        border: 1px solid transparent;
    }

    .btn-white {
        background: white;
        border-color: var(--border-color);
        color: var(--text-dark);
    }

    .btn-white:hover {
        background: #f9fafb;
        border-color: #d1d5db;
    }

    .btn-primary {
        background: var(--primary-green);
        color: white;
        border-color: var(--primary-green);
    }

    .btn-primary:hover {
        background: var(--primary-green-hover);
        border-color: var(--primary-green-hover);
    }
    
    .btn-outline-sm {
        padding: 0.4rem 0.75rem;
        font-size: 0.8125rem;
        border: 1px solid var(--border-color);
        background: white;
        color: var(--text-dark);
        border-radius: 6px;
        display: inline-flex;
        align-items: center;
        gap: 0.4rem;
        font-weight: 500;
    }

    .btn-outline-sm:hover {
        border-color: var(--primary-green);
        color: var(--primary-green);
    }

    .btn-icon-danger {
        border: none;
        background: none;
        color: #ef4444;
        padding: 4px;
        border-radius: 4px;
        cursor: pointer;
        transition: background 0.2s;
    }

    .btn-icon-danger:hover {
        background: #fee2e2;
    }

    /* Grid Layout */
    .factura-grid {
        display: grid;
        grid-template-columns: 1fr 340px;
        gap: 1.5rem;
    }

    .factura-main {
        min-width: 0; 
    }

    /* Cards */
    .card {
        background: white;
        border-radius: 12px;
        border: none;
        box-shadow: 0 1px 3px rgba(0,0,0,0.05); 
    }
    
    .card-title {
        font-size: 1rem;
        font-weight: 600;
        color: var(--text-dark);
    }

    /* Forms */
    .form-label {
        font-size: 0.875rem;
        font-weight: 500;
        color: var(--text-dark);
        margin-bottom: 0.375rem;
        display: block;
    }

    .form-control, .form-select {
        border: 1px solid var(--border-color);
        border-radius: 8px;
        padding: 0.625rem 0.875rem;
        font-size: 0.875rem;
        color: var(--text-dark);
        width: 100%;
        transition: all 0.2s;
    }

    .form-control:focus, .form-select:focus {
        border-color: var(--primary-green);
        box-shadow: 0 0 0 3px rgba(16, 185, 129, 0.1);
        outline: none;
    }

    .form-control.bg-light {
        background-color: #f9fafb;
        color: #6b7280;
    }
    
    .search-wrapper {
        position: relative;
    }
    
    .search-icon {
        position: absolute;
        left: 12px;
        top: 50%;
        transform: translateY(-50%);
        color: #9ca3af;
        pointer-events: none;
    }
    
    .search-input {
        padding-left: 36px;
    }

    /* Autocomplete */
    .autocomplete-list {
        position: absolute;
        top: 100%;
        left: 0;
        right: 0;
        background: white;
        border: 1px solid var(--border-color);
        border-radius: 8px;
        margin-top: 4px;
        max-height: 250px;
        overflow-y: auto;
        z-index: 50;
        box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        display: none;
    }

    .autocomplete-list.show {
        display: block;
    }

    .autocomplete-item {
        padding: 0.75rem 1rem;
        font-size: 0.875rem;
        cursor: pointer;
        border-bottom: 1px solid #f3f4f6;
    }

    .autocomplete-item:last-child {
        border-bottom: none;
    }

    .autocomplete-item:hover {
        background-color: #f9fafb;
    }

    /* Products Table */
    .products-container {
        border: 1px solid #f3f4f6;
        border-radius: 8px;
    }

    .products-header {
        display: grid;
        grid-template-columns: 2fr 100px 120px 100px 120px 40px;
        gap: 12px;
        padding: 12px 16px;
        background: #f9fafb;
        border-bottom: 1px solid var(--border-color);
        font-size: 0.75rem;
        font-weight: 600;
        color: var(--text-light);
        text-transform: uppercase;
        border-radius: 8px 8px 0 0;
    }

    .product-row {
        display: grid;
        grid-template-columns: 2fr 100px 120px 100px 120px 40px;
        gap: 12px;
        padding: 12px 16px;
        align-items: flex-start; /* Align top if select wraps */
        border-bottom: 1px solid #f3f4f6;
    }
    
    .product-row:last-child {
        border-bottom: none;
    }

    /* Sidebar Specifics */
    .sticky-sidebar {
        position: sticky;
        top: 2rem;
    }
    
    .custom-select {
        background-color: white;
    }
    
    .resumen-title {
        font-size: 0.9375rem;
        font-weight: 600;
        color: var(--text-dark);
        display: flex;
        align-items: center;
    }
    
    .total-display {
        margin-top: 1rem;
    }
    
    .total-amount {
        font-size: 1.5rem;
        font-weight: 700;
        color: var(--primary-green);
    }
    
    .total-label {
        font-weight: 600;
        font-size: 1rem;
    }

    .preview-table th {
        font-size: 0.75rem;
        text-transform: uppercase;
        color: var(--text-light);
        letter-spacing: 0.02em;
    }

    /* Responsive */
    @@media (max-width: 1024px) {
        .factura-grid {
            grid-template-columns: 1fr;
        }
        
        .factura-header-area {
            flex-direction: column;
            align-items: flex-start;
            gap: 1rem;
        }
        
        .header-actions {
            width: 100%;
            justify-content: flex-start;
        }
    }

    @@media (max-width: 768px) {
        .products-header {
             display: none; /* Hide header on mobile, stack rows instead */
        }
        
        .product-row {
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            padding: 16px;
            border-bottom: 4px solid #f3f4f6;
        }
        
        .col-producto { grid-column: 1 / -1; }
        .col-cantidad { grid-column: 1 / 2; }
        .col-precio { grid-column: 2 / -1; }
        .col-desc { grid-column: 1 / 2; }
        .col-subtotal { grid-column: 2 / -1; }
        .col-action { grid-column: 2 / -1; justify-self: end; }
    }
</style>

<script>
    // Cargar clientes al abrir la página
    let clientes = [];
    let productos = [];
    let contador = 1;

    const BORRADOR_KEY = 'factura_borrador';
    const BORRADOR_TTL_MS = 60 * 60 * 1000;

    document.addEventListener('DOMContentLoaded', async function () {
        limpiarBorradorExpirado();
        await cargarClientes();
        await cargarProductos();
        inicializarEventos();
        cargarBorradorLocal();
        calcularTotales(); // Calcular totales iniciales con dólares por defecto
        
        // Recargar clientes cuando se vuelve a la página después de crear uno nuevo
        window.addEventListener('focus', async function() {
            if (document.getElementById('clienteSearch') && !document.getElementById('clienteId').value) {
                await cargarClientes();
            }
        });
    });

    function normalizarCliente(cliente) {
        const id = cliente?.id ?? cliente?.Id ?? null;
        const nombre = cliente?.nombre ?? cliente?.Nombre ?? '';
        const nitDui = cliente?.nitDui ?? cliente?.NitDui ?? cliente?.nit_dui ?? '';
        const email = cliente?.email ?? cliente?.Email ?? '';
        const direccion = cliente?.direccion ?? cliente?.Direccion ?? '';
        return {
            id,
            nombre,
            nitDui,
            email,
            direccion
        };
    }

    async function cargarClientes() {
        try {
            const response = await fetch('/api/clientes');
            const data = await response.json();
            clientes = (Array.isArray(data) ? data : [])
                .map(normalizarCliente)
                .filter(c => c.id !== null && c.nombre);
        } catch (error) {
            console.error('Error cargando clientes:', error);
            clientes = [];
        }
    }

    async function cargarProductos() {
        try {
            const response = await fetch('/api/productos');
            const data = await response.json();
            productos = (Array.isArray(data) ? data : [])
                .map(normalizarProducto)
                .filter(p => p.id !== null && p.nombre);
            actualizarSelectsProductos();
            calcularTotales();
        } catch (error) {
            console.error('Error cargando productos:', error);
        }
    }

    function normalizarProducto(producto) {
        const id = producto?.id_producto ?? producto?.idProducto ?? producto?.IdProducto ?? producto?.id ?? null;
        const nombre = producto?.nombre_producto ?? producto?.nombreProducto ?? producto?.NombreProducto ?? producto?.nombre ?? producto?.Nombre ?? '';
        const precio = producto?.precio ?? producto?.Precio ?? producto?.precioUnitario ?? producto?.PrecioUnitario ?? 0;
        return {
            id,
            nombre,
            precio: parseFloat(precio) || 0
        };
    }

    function obtenerSimboloMoneda() {
        return document.getElementById('moneda').value === 'USD' ? '$' : 'S/';
    }

    function formatearMoneda(valor) {
        return `${obtenerSimboloMoneda()}${valor.toFixed(2)}`;
    }

    function obtenerProductoPorId(id) {
        return productos.find(p => String(p.id) === String(id));
    }

    function construirOpcionesProductos() {
        return productos
            .map(p => `<option value="${p.id}">${p.nombre} - ${formatearMoneda(p.precio)}</option>`)
            .join('');
    }

    function actualizarSelectsProductos() {
        document.querySelectorAll('.producto-select').forEach(select => {
            const currentValue = select.value;
            const html = construirOpcionesProductos();
            select.innerHTML = '<option value="">Seleccionar...</option>' + html;
            select.value = currentValue;
        });
    }

    function inicializarEventos() {
        // Búsqueda de clientes
        document.getElementById('clienteSearch').addEventListener('input', function (e) {
            const value = e.target.value.toLowerCase();
            const lista = document.getElementById('clienteList');

            if (!value) {
                lista.classList.remove('show');
                return;
            }

            const filtered = clientes.filter(c =>
                c.nombre.toLowerCase().includes(value) ||
                (c.nitDui && c.nitDui.toLowerCase().includes(value))
            );

            if (filtered.length > 0) {
                lista.innerHTML = filtered.map(c =>
                    `<div class="autocomplete-item" onclick="seleccionarCliente('${c.id}', '${(c.nombre || '').replace(/'/g, "\\'")}', '${(c.nitDui || '').replace(/'/g, "\\'")}', '${(c.email || '').replace(/'/g, "\\'")}', '${(c.direccion || '').replace(/'/g, "\\'")}')">
                        <strong>${c.nombre}</strong><br>
                        <small class="text-muted">${c.nitDui || 'Sin NIT/DUI'}</small>
                    </div>`
                ).join('');
                lista.classList.add('show');
            } else {
                lista.classList.remove('show');
            }
        });
        
        // Hide autocomplete when clicking outside
        document.addEventListener('click', function(e) {
            if (!e.target.closest('.search-wrapper')) {
                document.getElementById('clienteList').classList.remove('show');
            }
        });

        // Agregar producto
        document.getElementById('btnAgregarProducto').addEventListener('click', agregarProducto);

        // Calcular totales
        document.addEventListener('input', function (e) {
            if (e.target.classList.contains('cantidad') || 
                e.target.classList.contains('descuento')) {
                calcularTotales();
            }
        });

        document.addEventListener('change', function (e) {
            if (e.target.classList.contains('producto-select')) {
                calcularTotales();
            }
        });

        document.getElementById('moneda').addEventListener('change', function () {
            actualizarSelectsProductos();
            calcularTotales();
        });

        document.getElementById('btnPreview').addEventListener('click', mostrarPreview);

        // Agregar listener al botón Emitir Factura
        const btnEmitir = document.getElementById('btnEmitirFactura');
        if (btnEmitir) {
            btnEmitir.addEventListener('click', function(e) {
                e.preventDefault();
                emitirFactura(e);
            });
        }

        document.getElementById('facturaForm').addEventListener('submit', emitirFactura);

        const btnGuardar = document.getElementById('btnGuardar');
        if (btnGuardar) {
            btnGuardar.addEventListener('click', function () {
                guardarBorradorLocal();
                alert('Borrador guardado por 1 hora.');
            });
        }
    }

    function seleccionarCliente(id, nombre, nit, email, direccion) {
        document.getElementById('clienteId').value = id || '';
        document.getElementById('clienteSearch').value = nombre || '';
        document.getElementById('nit').value = nit || '';
        document.getElementById('email').value = email || '';
        document.getElementById('direccion').value = direccion || '';
        document.getElementById('clienteList').classList.remove('show');
    }

    function agregarProducto() {
        contador++;
        const tbody = document.getElementById('productosBody');
        const fila = document.createElement('div');
        fila.id = `item-${contador}`;
        fila.className = 'product-row';
        fila.innerHTML = `
            <div class="col-producto">
                <select class="form-control producto-select" name="Items[${contador - 1}].IdProducto" required>
                    <option value="">Seleccionar...</option>
                    ${construirOpcionesProductos()}
                </select>
            </div>
            <div class="col-cantidad">
                <input type="number" class="form-control text-center cantidad" name="Items[${contador - 1}].Cantidad" value="1" min="1" step="1" required>
            </div>
            <div class="col-precio">
                <input type="number" class="form-control text-end precio-unit" name="Items[${contador - 1}].PrecioUnitario" step="0.01" value="0.00" readonly>
            </div>
            <div class="col-desc">
                <input type="number" class="form-control text-center descuento" name="Items[${contador - 1}].Descuento" step="0.01" value="0" min="0">
            </div>
            <div class="col-subtotal">
                <input type="text" class="form-control text-end subtotal bg-light" value="$0.00" readonly>
            </div>
            <div class="col-action">
                <button type="button" class="btn-icon-danger" onclick="eliminarProducto(${contador})">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path></svg>
                </button>
            </div>
        `;
        tbody.appendChild(fila);
        calcularTotales();
    }

    function eliminarProducto(id) {
        const item = document.getElementById(`item-${id}`);
        if (item) {
            item.remove();
            calcularTotales();
        }
    }

    function calcularTotales() {
        let subtotal = 0;
        const moneda = obtenerSimboloMoneda();

        document.querySelectorAll('.product-row').forEach((row) => {
            const selectProducto = row.querySelector('.producto-select');
            const cantidad = parseFloat(row.querySelector('.cantidad').value) || 0;
            const descuento = parseFloat(row.querySelector('.descuento').value) || 0;
            const precioUnitInput = row.querySelector('.precio-unit');
            const subtotalInput = row.querySelector('.subtotal');

            if (selectProducto.value) {
                const producto = obtenerProductoPorId(selectProducto.value);
                if (producto) {
                    const precio = parseFloat(producto.precio) || 0;
                    precioUnitInput.value = precio.toFixed(2);

                    const lineaSubtotal = Math.max(0, (precio * cantidad) - descuento);
                    subtotalInput.value = `${moneda}${lineaSubtotal.toFixed(2)}`;
                    subtotal += lineaSubtotal;
                } else {
                    precioUnitInput.value = '0.00';
                    subtotalInput.value = `${moneda}0.00`;
                }
            } else {
                precioUnitInput.value = '0.00';
                subtotalInput.value = `${moneda}0.00`;
            }
        });

        const iva = subtotal * 0.13;
        const total = subtotal + iva;

        document.getElementById('subtotalValue').textContent = `${moneda}${subtotal.toFixed(2)}`;
        document.getElementById('ivaValue').textContent = `${moneda}${iva.toFixed(2)}`;
        document.getElementById('totalValue').textContent = `${moneda}${total.toFixed(2)}`;
        document.getElementById('finalTotal').textContent = `${moneda}${total.toFixed(2)}`;
    }

    function mostrarPreview() {
        calcularTotales();
        const modalElement = document.getElementById('facturaPreviewModal');
        if (!modalElement) return;

        document.getElementById('previewClienteNombre').textContent = document.getElementById('clienteSearch').value || '—';
        document.getElementById('previewClienteDocumento').textContent = document.getElementById('nit').value || '—';
        document.getElementById('previewClienteEmail').textContent = document.getElementById('email').value || '—';
        document.getElementById('previewClienteDireccion').textContent = document.getElementById('direccion').value || '—';
        document.getElementById('previewTipoDocumento').textContent = document.getElementById('tipoDocumento').selectedOptions[0]?.text || '—';
        document.getElementById('previewSerie').textContent = `Serie: ${document.getElementById('serie').value || '—'}`;
        document.getElementById('previewFechaEmision').textContent = `Emisión: ${document.getElementById('fechaEmision').value || '—'}`;
        document.getElementById('previewFechaVencimiento').textContent = `Venc.: ${document.getElementById('fechaVencimiento').value || '—'}`;
        document.getElementById('previewMoneda').textContent = `Moneda: ${document.getElementById('moneda').selectedOptions[0]?.text || '—'}`;
        document.getElementById('previewDescripcion').textContent = document.getElementById('descripcion').value || '—';

        const previewBody = document.getElementById('previewItems');
        const filas = [];
        document.querySelectorAll('.product-row').forEach((row) => {
            const selectProducto = row.querySelector('.producto-select');
            if (!selectProducto.value) {
                return;
            }
            const producto = obtenerProductoPorId(selectProducto.value);
            const nombre = producto?.nombre || selectProducto.selectedOptions[0]?.text || 'Producto';
            const cantidad = parseFloat(row.querySelector('.cantidad').value) || 0;
            const descuento = parseFloat(row.querySelector('.descuento').value) || 0;
            const precio = parseFloat(row.querySelector('.precio-unit').value) || 0;
            const subtotalLinea = Math.max(0, (precio * cantidad) - descuento);

            filas.push(`
                <tr>
                    <td>${nombre}</td>
                    <td class="text-center">${cantidad}</td>
                    <td class="text-end">${formatearMoneda(precio)}</td>
                    <td class="text-end">${formatearMoneda(descuento)}</td>
                    <td class="text-end">${formatearMoneda(subtotalLinea)}</td>
                </tr>
            `);
        });

        if (filas.length === 0) {
            previewBody.innerHTML = '<tr><td colspan="5" class="text-center text-muted">Sin ítems</td></tr>';
        } else {
            previewBody.innerHTML = filas.join('');
        }

        document.getElementById('previewSubtotal').textContent = document.getElementById('subtotalValue').textContent || '—';
        document.getElementById('previewIgv').textContent = document.getElementById('ivaValue').textContent || '—';
        document.getElementById('previewTotal').textContent = document.getElementById('totalValue').textContent || '—';

        const modal = new bootstrap.Modal(modalElement);
        modal.show();
    }

    function emitirFactura(e) {
        if (e) {
            e.preventDefault();
        }

        const form = document.getElementById('facturaForm');
        if (!form) {
            console.error('Formulario no encontrado');
            return;
        }

        if (!form.reportValidity()) {
            return;
        }

        // Validar que al menos tenga nombre de cliente o datos básicos
        const clienteNombre = document.getElementById('clienteSearch')?.value || '';
        const clienteNit = document.getElementById('nit')?.value || '';
        
        if (!clienteNombre && !clienteNit) {
            alert('Debe ingresar al menos el nombre del cliente o su NIT/DUI');
            return;
        }

        const items = document.querySelectorAll('.product-row');
        let hasProduct = false;
        items.forEach(item => {
            const select = item.querySelector('.producto-select');
            if (select && select.value) {
                hasProduct = true;
            }
        });

        if (!hasProduct) {
            alert('Agrega al menos un producto válido');
            return;
        }

        guardarBorradorLocal();
        form.submit();
    }

    function limpiarBorradorExpirado() {
        try {
            const raw = localStorage.getItem(BORRADOR_KEY);
            if (!raw) return;
            const data = JSON.parse(raw);
            if (!data?.expiresAt || Date.now() > data.expiresAt) {
                localStorage.removeItem(BORRADOR_KEY);
            }
        } catch (error) {
            console.warn('No se pudo limpiar el borrador local:', error);
        }
    }

    function cargarBorradorLocal() {
        try {
            const raw = localStorage.getItem(BORRADOR_KEY);
            if (!raw) return;
            const data = JSON.parse(raw);
            if (!data?.expiresAt || Date.now() > data.expiresAt) {
                localStorage.removeItem(BORRADOR_KEY);
                return;
            }

            const payload = data.payload || {};

            document.getElementById('clienteId').value = payload.clienteId || '';
            document.getElementById('clienteSearch').value = payload.clienteNombre || '';
            document.getElementById('nit').value = payload.nit || '';
            document.getElementById('email').value = payload.email || '';
            document.getElementById('direccion').value = payload.direccion || '';
            document.getElementById('tipoDocumento').value = payload.tipoDocumento || '01';
            document.getElementById('serie').value = payload.serie || 'F001';
            document.getElementById('fechaEmision').value = payload.fechaEmision || '';
            document.getElementById('fechaVencimiento').value = payload.fechaVencimiento || '';
            document.getElementById('moneda').value = payload.moneda || 'USD';
            document.getElementById('descripcion').value = payload.descripcion || '';

            const detalle = Array.isArray(payload.detalle) ? payload.detalle : [];
            const tbody = document.getElementById('productosBody');

            if (detalle.length > 0) {
                tbody.innerHTML = '';
                detalle.forEach((item, index) => {
                    const rowIndex = index + 1;
                    const fila = document.createElement('div');
                    fila.id = `item-${rowIndex}`;
                    fila.className = 'product-row';
                    fila.innerHTML = `
                        <div class="col-producto">
                            <select class="form-control producto-select" name="Items[${index}].IdProducto" required>
                                <option value="">Seleccionar...</option>
                                ${construirOpcionesProductos()}
                            </select>
                        </div>
                        <div class="col-cantidad">
                            <input type="number" class="form-control text-center cantidad" name="Items[${index}].Cantidad" value="${item.cantidad ?? 1}" min="1" step="1" required>
                        </div>
                        <div class="col-precio">
                            <input type="number" class="form-control text-end precio-unit" name="Items[${index}].PrecioUnitario" step="0.01" value="${(parseFloat(item.precioUnitario) || 0).toFixed(2)}" readonly>
                        </div>
                        <div class="col-desc">
                            <input type="number" class="form-control text-center descuento" name="Items[${index}].Descuento" step="0.01" value="${item.descuento ?? 0}" min="0">
                        </div>
                        <div class="col-subtotal">
                            <input type="text" class="form-control text-end subtotal bg-light" value="$0.00" readonly>
                        </div>
                        <div class="col-action">
                            <button type="button" class="btn-icon-danger" onclick="eliminarProducto(${rowIndex})">
                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path></svg>
                            </button>
                        </div>
                    `;
                    tbody.appendChild(fila);

                    const select = fila.querySelector('.producto-select');
                    if (select) {
                        select.value = item.productoId || '';
                    }
                });

                contador = detalle.length;
            } else {
                contador = 1;
            }

            actualizarSelectsProductos();
            calcularTotales();
        } catch (error) {
            console.warn('No se pudo cargar el borrador local:', error);
        }
    }

    function guardarBorradorLocal() {
        try {
            const detalle = [];
            document.querySelectorAll('.product-row').forEach((row) => {
                const productoId = row.querySelector('.producto-select')?.value || '';
                if (!productoId) return;

                detalle.push({
                    productoId,
                    cantidad: parseFloat(row.querySelector('.cantidad')?.value) || 0,
                    descuento: parseFloat(row.querySelector('.descuento')?.value) || 0,
                    precioUnitario: parseFloat(row.querySelector('.precio-unit')?.value) || 0
                });
            });

            const payload = {
                clienteId: document.getElementById('clienteId').value || '',
                clienteNombre: document.getElementById('clienteSearch').value || '',
                nit: document.getElementById('nit').value || '',
                email: document.getElementById('email').value || '',
                direccion: document.getElementById('direccion').value || '',
                tipoDocumento: document.getElementById('tipoDocumento').value || '',
                serie: document.getElementById('serie').value || '',
                fechaEmision: document.getElementById('fechaEmision').value || '',
                fechaVencimiento: document.getElementById('fechaVencimiento').value || '',
                moneda: document.getElementById('moneda').value || '',
                descripcion: document.getElementById('descripcion').value || '',
                subtotal: document.getElementById('subtotalValue').textContent || '',
                igv: document.getElementById('ivaValue').textContent || '',
                total: document.getElementById('totalValue').textContent || '',
                detalle
            };

            const data = {
                expiresAt: Date.now() + BORRADOR_TTL_MS,
                payload
            };

            const serialized = JSON.stringify(data);
            localStorage.setItem(BORRADOR_KEY, serialized);
            sessionStorage.setItem(BORRADOR_KEY, serialized);
        } catch (error) {
            console.warn('No se pudo guardar el borrador local:', error);
        }
    }
</script>
