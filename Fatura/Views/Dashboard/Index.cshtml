@using DocumentFormat.OpenXml.Office2010.PowerPoint
@{
    ViewData["Title"] = "Dashboard";
    Layout = "~/Views/Shared/_DashboardLayout.cshtml";
}

<div class="dashboard-page">
    <div class="page-header">
        <h1 class="page-title">Dashboard</h1>
        <p class="page-subtitle text-muted">Bienvenido de vuelta, Carlos. Aquí está el resumen de tu actividad.</p>
    </div>

    @* Widgets Row 1 - KPIs *@
    <div class="widgets-grid">
        @* Ingresos del Mes *@
        <div class="widget widget-primary">
            <div class="widget-header">
                <h3 class="widget-title">Ingresos del Mes</h3>
                <div class="widget-icon">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                    </svg>
                </div>
            </div>
            <div class="widget-content">
                <p class="widget-value">@ViewBag.IngresosDelMes?.ToString("C")</p>
                <p class="widget-change @(ViewBag.CambioIngresos >= 0 ? "positive" : "negative")">
                    <span class="change-icon">
                        @if (ViewBag.CambioIngresos >= 0)
                        {
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
                                <path d="M8 15A7 7 0 1 1 8 1a7 7 0 0 1 0 14zm0 1A8 8 0 1 0 8 0a8 8 0 0 0 0 16z" />
                                <path d="M8.5 5.5a.5.5 0 0 0-1 0v3.362l-1.447-1.447a.5.5 0 0 0-.707.707l2.5 2.5a.5.5 0 0 0 .708 0l2.5-2.5a.5.5 0 0 0-.707-.707L8.5 8.862V5.5z" />
                            </svg>
                        }
                        else
                        {
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
                                <path d="M8 15A7 7 0 1 1 8 1a7 7 0 0 1 0 14zm0 1A8 8 0 1 0 8 0a8 8 0 0 0 0 16z" />
                                <path d="M8.5 10.5a.5.5 0 0 0-1 0v-3.362l-1.447 1.447a.5.5 0 0 0-.707-.707l2.5-2.5a.5.5 0 0 0 .708 0l2.5 2.5a.5.5 0 0 0-.707.707L8.5 7.138V10.5z" />
                            </svg>
                        }
                    </span>
                    @string.Format("{0:+#.#;-#.#}", @ViewBag.CambioIngresos)% vs mes anterior
                </p>
            </div>
        </div>

        @* Facturas Emitidas *@
        <div class="widget">
            <div class="widget-header">
                <h3 class="widget-title">Facturas Emitidas</h3>
                <div class="widget-icon">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                    </svg>
                </div>
            </div>
            <div class="widget-content">
                <p class="widget-value">@ViewBag.FacturasEmitidas</p>
                <p class="widget-change @(ViewBag.CambioFacturas >= 0 ? "positive" : "negative")">
                    @if (ViewBag.CambioFacturas >= 0)
                    {
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
                            <path d="M8 15A7 7 0 1 1 8 1a7 7 0 0 1 0 14zm0 1A8 8 0 1 0 8 0a8 8 0 0 0 0 16z" />
                            <path d="M8.5 5.5a.5.5 0 0 0-1 0v3.362l-1.447-1.447a.5.5 0 0 0-.707.707l2.5 2.5a.5.5 0 0 0 .708 0l2.5-2.5a.5.5 0 0 0-.707-.707L8.5 8.862V5.5z" />
                        </svg>
                    }
                    else
                    {
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
                            <path d="M8 15A7 7 0 1 1 8 1a7 7 0 0 1 0 14zm0 1A8 8 0 1 0 8 0a8 8 0 0 0 0 16z" />
                            <path d="M8.5 10.5a.5.5 0 0 0-1 0v-3.362l-1.447 1.447a.5.5 0 0 0-.707-.707l2.5-2.5a.5.5 0 0 0 .708 0l2.5 2.5a.5.5 0 0 0-.707.707L8.5 7.138V10.5z" />
                        </svg>
                    }
                    @string.Format("{0:+#.#;-#.#}", @ViewBag.CambioFacturas)% vs mes anterior
                </p>
            </div>
        </div>

        @* Clientes Activos *@
        <div class="widget">
            <div class="widget-header">
                <h3 class="widget-title">Clientes Activos</h3>
                <div class="widget-icon">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z" />
                    </svg>
                </div>
            </div>
            <div class="widget-content">
                <p class="widget-value">@ViewBag.ClientesActivos</p>
                <p class="widget-change @(ViewBag.CambioClientes >= 0 ? "positive" : "negative")">
                    @if (ViewBag.CambioClientes >= 0)
                    {
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
                            <path d="M8 15A7 7 0 1 1 8 1a7 7 0 0 1 0 14zm0 1A8 8 0 1 0 8 0a8 8 0 0 0 0 16z" />
                            <path d="M8.5 5.5a.5.5 0 0 0-1 0v3.362l-1.447-1.447a.5.5 0 0 0-.707.707l2.5 2.5a.5.5 0 0 0 .708 0l2.5-2.5a.5.5 0 0 0-.707-.707L8.5 8.862V5.5z" />
                        </svg>
                    }
                    else
                    {
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
                            <path d="M8 15A7 7 0 1 1 8 1a7 7 0 0 1 0 14zm0 1A8 8 0 1 0 8 0a8 8 0 0 0 0 16z" />
                            <path d="M8.5 10.5a.5.5 0 0 0-1 0v-3.362l-1.447 1.447a.5.5 0 0 0-.707-.707l2.5-2.5a.5.5 0 0 0 .708 0l2.5 2.5a.5.5 0 0 0-.707.707L8.5 7.138V10.5z" />
                        </svg>
                    }
                    @string.Format("{0:+#.#;-#.#}", @ViewBag.CambioClientes)% vs mes anterior
                </p>
            </div>
        </div>

        @* Tasa de Cobro *@
        <div class="widget">
            <div class="widget-header">
                <h3 class="widget-title">Tasa de Cobro</h3>
                <div class="widget-icon">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z" />
                    </svg>
                </div>
            </div>
            <div class="widget-content">
                <p class="widget-value">@ViewBag.TasaDeCobro?.ToString("P2")</p>
                <p class="widget-change @(ViewBag.CambioTasaCobro >= 0 ? "positive" : "negative")">
                    @if (ViewBag.CambioTasaCobro >= 0)
                    {
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
                            <path d="M8 15A7 7 0 1 1 8 1a7 7 0 0 1 0 14zm0 1A8 8 0 1 0 8 0a8 8 0 0 0 0 16z" />
                            <path d="M8.5 5.5a.5.5 0 0 0-1 0v3.362l-1.447-1.447a.5.5 0 0 0-.707.707l2.5 2.5a.5.5 0 0 0 .708 0l2.5-2.5a.5.5 0 0 0-.707-.707L8.5 8.862V5.5z" />
                        </svg>
                    }
                    else
                    {
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
                            <path d="M8 15A7 7 0 1 1 8 1a7 7 0 0 1 0 14zm0 1A8 8 0 1 0 8 0a8 8 0 0 0 0 16z" />
                            <path d="M8.5 10.5a.5.5 0 0 0-1 0v-3.362l-1.447 1.447a.5.5 0 0 0-.707-.707l2.5-2.5a.5.5 0 0 0 .708 0l2.5 2.5a.5.5 0 0 0-.707.707L8.5 7.138V10.5z" />
                        </svg>
                    }
                    @string.Format("{0:+#.#;-#.#}", @ViewBag.CambioTasaCobro)% vs mes anterior
                </p>
            </div>
        </div>
    </div>

    @* Charts and Tables Row *@
    <div class="dashboard-row">
        @* Monthly Income Chart *@
        <div class="widget widget-chart">
            <div class="widget-header">
                <h3 class="widget-title">Ingresos Mensuales</h3>
                <p class="widget-subtitle">Evolución de los últimos 7 meses</p>
            </div>
            <div class="widget-content chart-container">
                <canvas id="chartIngresos"></canvas>
            </div>
        </div>

        @* Quick Actions *@
        <div class="widget widget-actions">
            <div class="widget-header">
                <h3 class="widget-title">Acciones Rápidas</h3>
            </div>
            <div class="widget-content">
                <div class="quick-action-item">
                    <div class="action-icon" style="background-color: #10b98133;">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke="#10b981">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" />
                        </svg>
                    </div>
                    <div class="action-info">
                        <h4 class="action-title">Nueva Factura</h4>
                        <p class="action-description">Crear factura electrónica</p>
                    </div>
                    <a href="@Url.Action("Create", "Facturas")" class="action-link">
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
                        </svg>
                    </a>
                </div>

                <div class="quick-action-item">
                    <div class="action-icon" style="background-color: #3b82f633;">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke="#3b82f6">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M18 9v3m0 0v3m0-3h3m-3 0h-3m-2-5a4 4 0 11-8 0 4 4 0 018 0zM3 20a6 6 0 0112 0v1H3v-1z" />
                        </svg>
                    </div>
                    <div class="action-info">
                        <h4 class="action-title">Nuevo Cliente</h4>
                        <p class="action-description">Registrar cliente</p>
                    </div>
                    <a href="@Url.Action("Create", "Clientes")" class="action-link">
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
                        </svg>
                    </a>
                </div>

                <div class="quick-action-item">
                    <div class="action-icon" style="background-color: #8b5cf633;">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke="#8b5cf6">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10M4 7v10l8 4" />
                        </svg>
                    </div>
                    <div class="action-info">
                        <h4 class="action-title">Nuevo Producto</h4>
                        <p class="action-description">Agregar producto/servicio</p>
                    </div>
                    <a href="@Url.Action("Create", "Productos")" class="action-link">
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
                        </svg>
                    </a>
                </div>
            </div>
        </div>
    </div>

    @* Recent Invoices Table *@
    <div class="widget">
        <div class="widget-header">
            <h3 class="widget-title">Facturas Recientes</h3>
            <p class="widget-subtitle">Últimas 5 facturas del sistema</p>
            <a href="@Url.Action("Index", "Facturas")" class="widget-link">Ver todas</a>
        </div>
        <div class="widget-content table-container">
            <table class="table">
                <thead>
                    <tr>
                        <th>FACTURA</th>
                        <th>CLIENTE</th>
                        <th>FECHA</th>
                        <th>MONTO</th>
                        <th>ESTADO</th>
                    </tr>
                </thead>
                <tbody>
                    @if (ViewBag.FacturasRecientes != null && ViewBag.FacturasRecientes.Count > 0)
                    {
                        @foreach (var factura in ViewBag.FacturasRecientes)
                        {
                            <tr>
                                <td><strong>#@factura.Id</strong></td>
                                <td>@factura.ClienteNombre</td>
                                <td>@factura.FechaEmision?.ToString("dd/MM/yyyy")</td>
                                <td>@factura.Total?.ToString("C")</td>
                                <td>
                                    <span class="badge badge-@factura.Estado?.ToLower()">
                                        @factura.Estado
                                    </span>
                                </td>
                            </tr>
                        }
                    }
                    else
                    {
                        <tr>
                            <td colspan="5" class="text-center text-muted">No hay facturas disponibles</td>
                        </tr>
                    }
                </tbody>
            </table>
        </div>
    </div>
</div>

<script>
    // Chart.js implementation for monthly income (if Chart.js is included)
    document.addEventListener('DOMContentLoaded', function() {
        if (typeof Chart !== 'undefined') {
            var ctx = document.getElementById('chartIngresos');
            if (ctx) {
                const ingresosMensuales = @Html.Raw(System.Text.Json.JsonSerializer.Serialize(ViewBag.IngresosMensuales ?? new List<object>()));
                
                if (ingresosMensuales && ingresosMensuales.length > 0) {
                    new Chart(ctx, {
                        type: 'line',
                        data: {
                            labels: ingresosMensuales.map((_, i) => {
                                const date = new Date();
                                date.setMonth(date.getMonth() - (ingresosMensuales.length - 1 - i));
                                return date.toLocaleDateString('es-ES', { month: 'short' });
                            }),
                            datasets: [{
                                label: 'Ingresos',
                                data: ingresosMensuales,
                                borderColor: '#10b981',
                                backgroundColor: 'rgba(16, 185, 129, 0.1)',
                                borderWidth: 2,
                                fill: true,
                                tension: 0.4,
                                pointRadius: 4,
                                pointBackgroundColor: '#10b981'
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: {
                                legend: {
                                    display: false
                                }
                            },
                            scales: {
                                y: {
                                    beginAtZero: true,
                                    ticks: {
                                        callback: function(value) {
                                            return '$' + value.toLocaleString();
                                        }
                                    }
                                }
                            }
                        }
                    });
                }
            }
        }
    });
</script>
